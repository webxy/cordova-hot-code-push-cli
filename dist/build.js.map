{"version":3,"sources":["../src/build.js"],"names":[],"mappings":"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","file":"build.js","sourcesContent":["(function() {\n  var path = require('path'),\n    prompt = require('prompt'),\n    fs = require('fs-extra'),\n    async = require('async'),\n    crypto = require('crypto'),\n    Q = require('q'),\n    _ = require('lodash'),\n    createHash = require('crypto').createHash,\n    recursive = require('recursive-readdir'),\n    hidefile = require('hidefile'),\n    chcpContext;\n\n  module.exports = {\n    execute: execute\n  };\n\n  function execute(context) {\n    chcpContext = context;\n\n    var executeDfd = Q.defer(),\n      config = prepareConfig(context),\n      ignore = context.ignoredFiles;\n\n    recursive(chcpContext.sourceDirectory, ignore, function(err, files) {\n      var hashQueue = prepareFilesHashQueue(files);\n\n      async.parallelLimit(hashQueue, 10, function(err, result) {\n        result.sort((a, b) => {\n          return a.file.localeCompare(b.file)\n        });\n        var json = JSON.stringify(result, null, 2);\n        var manifestFile = chcpContext.manifestFilePath;\n\n        fs.writeFile(manifestFile, json, function(err) {\n          if (err) {\n            return console.log(err);\n          }\n\n          if (context.argv && context.argv.localdev) {\n            config.update = 'now';\n          }\n          var json = JSON.stringify(config, null, 2);\n          fs.writeFile(chcpContext.projectsConfigFilePath, json, function(err) {\n            if (err) {\n              return console.log(err);\n            }\n            console.log('Build ' + config.release + ' created in ' + chcpContext.sourceDirectory);\n            executeDfd.resolve(config);\n          });\n        });\n      });\n    });\n\n    return executeDfd.promise;\n  }\n\n  function prepareFilesHashQueue(files) {\n    var queue = [];\n    for (var i in files) {\n      var file = files[i];\n      if (!hidefile.isHiddenSync(file)) {\n        queue.push(hashFile.bind(null, file));\n      }\n    }\n\n    return queue;\n  }\n\n  function prepareConfig(context) {\n    var config = {};\n\n    try {\n      config = fs.readFileSync(context.defaultConfig, 'utf8');\n      config = JSON.parse(config);\n      config.release = process.env.VERSION || calculateTimestamp();\n    } catch (e) {\n      config = {\n        autogenerated: true,\n        release: calculateTimestamp()\n      };\n    }\n\n    if (context.argv && context.argv.content_url) {\n      config.content_url = context.argv.content_url;\n    }\n\n    console.log('Config', config);\n    return config;\n  }\n\n  function hashFile(filename, callback) {\n    var hash = crypto.createHash('md5'),\n      stream = fs.createReadStream(filename);\n\n    //stream.pipe(writeStream);\n    //console.log('Hashing: ', filename);\n    stream.on('data', function(data) {\n      hash.update(data, 'utf8');\n    });\n\n    stream.on('end', function() {\n      var result = hash.digest('hex'),\n        file = path.relative(chcpContext.sourceDirectory, filename).replace(new RegExp(\"\\\\\\\\\", \"g\"), \"/\");\n\n      callback(null, {\n        file: file,\n        hash: result\n      });\n    });\n  }\n\n  function calculateTimestamp() {\n    var currentdate = new Date();\n    return currentdate.getFullYear() + '.' +\n      (((currentdate.getMonth() + 1) < 10) ? '0' + (currentdate.getMonth() + 1) : (currentdate.getMonth() + 1)) + '.' +\n      ((currentdate.getDate() < 10) ? '0' + currentdate.getDate() : currentdate.getDate()) + '-' +\n      ((currentdate.getHours() < 10) ? '0' + currentdate.getHours() : currentdate.getHours()) + '.' +\n      ((currentdate.getMinutes() < 10) ? '0' + currentdate.getMinutes() : currentdate.getMinutes()) + '.' +\n      ((currentdate.getSeconds() < 10) ? '0' + currentdate.getSeconds() : currentdate.getSeconds());\n  }\n})();\n"]}