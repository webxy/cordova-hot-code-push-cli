{"version":3,"sources":["../src/deploy.js"],"names":[],"mappings":"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","file":"deploy.js","sourcesContent":["(function(){\n  var path = require('path'),\n      prompt = require('prompt'),\n      build = require('./build.js').execute,\n      fs = require('fs'),\n      Q = require('q'),\n      _ = require('lodash'),\n      s3sync = require('s3-sync-aws'),\n      readdirp = require('readdirp'),\n      loginFile = path.join(process.cwd(), '.chcplogin');\n\n  module.exports = {\n    execute: execute\n  };\n\n  function execute(context) {\n    var executeDfd = Q.defer();\n\n    build(context).then(function(){\n      deploy(context).then(function(){\n        executeDfd.resolve();\n      });\n    });\n\n    return executeDfd.promise;\n  }\n\n  function deploy(context) {\n    var executeDfd = Q.defer(),\n        config,\n        credentials,\n        ignore = context.ignoredFiles;\n\n    try {\n      config = fs.readFileSync(context.defaultConfig, 'utf8');\n      config = JSON.parse(config);\n    } catch(e) {\n      console.log('Cannot parse cordova-hcp.json. Did you run cordova-hcp init?');\n      process.exit(0);\n    }\n    if(!config) {\n      console.log('You need to run \"cordova-hcp init\" before you can run \"cordova-hcp login\".');\n      console.log('Both commands needs to be invoked in the root of the project directory.');\n      process.exit(0);\n    }\n    try {\n      credentials = fs.readFileSync(loginFile, 'utf8');\n      credentials = JSON.parse(credentials);\n    } catch(e) {\n      console.log('Cannot parse .chcplogin: ', e);\n    }\n    if(!credentials) {\n      console.log('You need to run \"cordova-hcp login\" before you can run \"cordova-hcp deploy\".');\n      process.exit(0);\n    }\n\n    ignore = ignore.filter( ignoredFile => !ignoredFile.match(/^chcp/) )\n    ignore = ignore.map( ignoredFile => `!${ignoredFile}` )\n\n    // console.log('Credentials: ', credentials);\n    // console.log('Config: ', config);\n    // console.log('Ignore: ', ignore);\n\n    var files = readdirp({\n      root: context.sourceDirectory,\n      fileFilter: ignore\n    });\n\n    var uploader = s3sync({\n      key: credentials.key,\n      secret: credentials.secret,\n      region: config.s3region,\n      bucket: config.s3bucket,\n      prefix: config.s3prefix,\n      acl: 'public-read',\n      headers: {\n        CacheControl: 'no-cache, no-store, must-revalidate',\n        Expires: 0\n      },\n      concurrency: 20\n    }).on('data', function(file) {\n      if (file.fresh) {\n        console.log(\"Updated \" + file.fullPath + ' -> ' + file.url)\n      }\n    });\n\n    files.pipe(uploader);\n\n    console.log('Deploy started');\n    uploader.on('error', function(err) {\n      console.error(\"unable to sync:\", err.stack);\n      executeDfd.reject();\n    });\n    uploader.on('fail', function(err) {\n      console.error(\"unable to sync:\", err);\n      executeDfd.reject();\n    });\n\n    //uploader.on('progress', function() {\n    //  var progress = uploader.progressTotal - uploader.progressAmount;\n    //  console.log(\"progress\", progress, uploader.progressTotal, uploader.progressAmount);\n    //});\n    uploader.on('end', function() {\n      console.log(\"Deploy done\");\n      executeDfd.resolve();\n    });\n    return executeDfd.promise;\n  }\n})();\n"]}